<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Antecipação de Recebíveis</title>

		<link rel="stylesheet" href="dc.css">
		<link rel="stylesheet" type="text/css" href="bootstrap.css">
	</head>

	<body>
		<h1>Antecipação de Recebíveis</h1>

		<div id="chart-ring-year" style="width:300px; height:330px">
			<div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
				<a href="javascript:yearRingChart.filterAll();dc.redrawAll();">reset</a>
			</div>
		</div>
<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
		<div id="chart-hist-spend" style="width:300px; height:330px">
			<div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
				<a href="javascript:spendHistChart.filterAll();dc.redrawAll();">reset</a>
			</div>
		</div>

		<div>
			<div class="dc-data-count">  <!-- texto acima do gáfico -->
				<span class="filter-count"></span> selecionado de <span class="total-count"></span> dados. | <a */
					href="javascript:dc.filterAll(); dc.renderAll();">Resetar Tudo</a>
			</div>
		</div>
		<table class="table table-hover dc-data-table">
		</table>

		<!-- chamando as bibliotecas: d3, crossfilter, dc -->
		<script src="https://d3js.org/d3.v5.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.js"></script>
		<script src="http://unpkg.com/dc@3/dc.js"></script>

		<script>

			//criando as variáveis dos gráficos e tabelas
			var yearRingChart   = dc.barChart("#chart-ring-year"),
				histSpendChart   = dc.barChart("#chart-hist-spend"),
				visCount = dc.dataCount(".dc-data-count"),
				visTable = dc.dataTable(".dc-data-table");

			//criando uma variável chamada URL para armazenar o arquivo .csv com os dados
			var url = "data.csv";

			//formatando a data
			var dateFormatSpecifier = '%Y-%m-%d';
			//var dateFormat = d3.timeFormat(dateFormatSpecifier);
			var dateFormatParser = d3.timeParse(dateFormatSpecifier);

			//funçao forEach (para cada interação) geral que chama os dados (arquivo .csv) e formata ele nos gráficos e nas tabelas
			d3.csv(url).then(function (data) {
				//Tratamento dos dados recebido do csv
				data.forEach(function (d) {
					d.dd = dateFormatParser(d.date);
					d.month = d3.timeMonth(d.dd);
					d.totalPago = d.totalPago.match(/\d+/)[0]; //retira só os números da coluna TOTAL PAGO do arquivo .csv
					d.antecipado = d.antecipado.match(/\d+/)[0]; //retira só os números da coluna "" do arquivo .csv
					d.custodiado = d.custodiado.match(/\d+/)[0]; //retira só os números da coluna "" do arquivo .csv
					d.my = (d.dd.getMonth()+1) + '/' + d.dd.getFullYear();
					d.cnpj = d.cnpj.substr(0,2) + '.' + d.cnpj.substr(2,3) + '.' + d.cnpj.substr(5,3) + '/' + d.cnpj.substr(8,4) + '-' + d.cnpj.substr(12,2); //formata o CNPJ com ./-
					d.nome = d.nome;
					d.ord = d.ord;
				});


				var ndx = crossfilter(data), //adiciona os dados no crossfilter
					all = ndx.groupAll(),  //agrupa todos os dados e reduz a um valor único

					//ajustando as dimensões dos gráficos
					anoDim = ndx.dimension(function (d) { return +d.dd.getFullYear(); }),
					anoMesDim = ndx.dimension(function (d) { return d.my; }),
					totalPagoDim = ndx.dimension(function (d) { return +d.totalPago; }),
					antecipadoDim = ndx.dimension(function (d) { return +d.antecipado; }),
					custodiadoDim = ndx.dimension(function (d) { return +d.custodiado; }),
					ordemDim = ndx.dimension(function (d) { return +d.ord; }),
					nomeDim = ndx.dimension(function (d) { return d.nome; }),
					cnpjDim = ndx.dimension(function (d) { return d.cnpj; }),

					anoMesPorCustodiado = custodiadoDim.group().reduceSum(function (d) { return d.dd; }),
					totalPagoPorAnoMes = anoMesDim.group().reduceSum(function (d) { return d.totalPago; }),
					totalPagoPorAno = anoDim.group().reduceSum(function (d) { return d.totalPago; });


				yearRingChart
						.width(300)
						.width(578)
						.height(200)
						.x(d3.scaleBand())
						.xUnits(dc.units.ordinal)
						.brushOn(false)
						.xAxisLabel('Mes Ano')
						.yAxisLabel('Pago')
						.dimension(anoMesDim)
						.outerPadding(0.05)
						.group(totalPagoPorAnoMes)
						.controlsUseVisibility(true);

				histSpendChart
					.width(578)
					.height(200)
					.x(d3.scaleBand())
					.xUnits(dc.units.ordinal)
					.brushOn(false)
					.xAxisLabel('Mes Ano')
					.yAxisLabel('Pago')
					.dimension(anoMesDim)
					.outerPadding(0.05)
					.group(totalPagoPorAnoMes)
					.controlsUseVisibility(true);

				visCount
					.dimension(ndx)
					.group(all);

				visTable
					.dimension(anoDim)
					// Data table does not use crossfilter group but rather a closure
					// as a grouping function
					.columns([ //Colunas que aparecem na tabela da dash
						{
							label: 'Data',
							format: function(d) {
								return d.dd.getDay() + '/' + (d.dd.getMonth()+1) + '/' + d.dd.getFullYear();
							}
						},
						"ord",
						"atraso",
						{
							label: 'Total Pago',
							format: function(d) {
								return 'R$ ' + d.totalPago;
							}
						},
						{
							label: 'Antecipado',
							format: function(d) {
								return 'R$ ' + d.antecipado;
							}
						},
						{
							label: 'Custodiado',
							format: function(d) {
								return '$' + d.custodiado;
							}
						},
						"nome",
						"cnpj"
					]);

				dc.renderAll();

			});
		</script>
	</body>
</html>